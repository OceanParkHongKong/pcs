pipeline {
    agent { label 'larry_macbook' }

    environment {
        DOCKER_IMAGE = 'pcs_web_server_sqlite'
        DOCKER_CONTAINER = 'pcs_web_server_sqlite_container'
        SHARED_FILE = '/Users/username/Oceanpark/jenkins_docker_image_built.txt' // Shared file path
    }

    stages {
        stage('Checkout') {
            steps {
                script {
                    sh 'pwd'
                    checkout([$class: 'GitSCM', 
                              branches: [[name: '*/main']], 
                              doGenerateSubmoduleConfigurations: false, 
                              extensions: [], 
                              userRemoteConfigs: [[url: 'http://192.168.gitServer.ip:3000/accountname/people_count_op.git']]])
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    sh "docker build -t ${DOCKER_IMAGE}:${env.BUILD_ID} -f ./Dockerfile.web_server_sqlite ./"
                }
            }
        }

        stage('Stop and Remove Old Container') {
            steps {
                script {
                    sh "docker stop ${DOCKER_CONTAINER} || true"
                    sh "docker rm ${DOCKER_CONTAINER} || true"
                }
            }
        }

        stage('Remove Old Image') {
            steps {
                script {
                    sh "docker rmi ${DOCKER_IMAGE}:previous || true"
                }
            }
        }

        stage('Run New Container') {
            steps {
                script {
                    sh "docker run -d -p 5000:5000 -v /Users/username/Oceanpark/people_count_op/swift/people_count_database.db:/app/people_count_database.db --name ${DOCKER_CONTAINER} ${DOCKER_IMAGE}:${env.BUILD_ID}"
                }
            }
        }

        stage('Tag Image for Rollback') {
            steps {
                script {
                    sh "docker tag ${DOCKER_IMAGE}:${env.BUILD_ID} ${DOCKER_IMAGE}:previous"
                    
                    // Append the latest image tag to the shared file
                    sh "echo '${DOCKER_IMAGE}:${env.BUILD_ID}' >> ${SHARED_FILE}"
                }
            }
        }


    }

    post {
        always {
            cleanWs()
        }
    }
}